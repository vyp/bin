#! /usr/bin/env nix-shell
#! nix-shell -i 'guile -e main' -p guile git
!#
;; vim: ft=scheme

(use-modules (ice-9 pretty-print)
             (alist-utils)
             (io-helpers)
             (pipe))

(define lockfile (home-path "dots/nixos/pkgs/versions.scm"))
(define temp-clone-dir (home-path "dl/tmp"))

(define (dl repo)
  ((lambda (clone-dir)
     ;; TODO: Shallow clone if there is a date, i.e. (assoc-ref repo 'date).
     (system* "git" "clone" (assoc-ref repo 'url) clone-dir)
     clone-dir))
   (find-new-dir-from 1))

(define (version-info repo)
  (enter-dir repo)
  (->> (acons 'url
              (-> (system-output "git remote show origin -n")
                  (string-split (lambda (c) (char=? c #\newline)))
                  (cadr)
                  (string-split char-whitespace?)
                  (caddr))
              '())))

(define (main args)
  ((lambda (port)
     ((lambda (repos)
        (enter-dir temp-clone-dir)
        (->> (map dl repos)
           )
        (when (null? (fs-tree* temp-clone-dir))
              (rmdir temp-clone-dir))
        (close-port port))
      (read port)))
   (open-file lockfile "r+")))

;; Local Variables:
;; mode: scheme
;; End:
