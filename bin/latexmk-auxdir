#! /usr/bin/env bash

set -e

error-if-empty () {
  if [[ -z $1 ]]; then
    echo "Error: $2 unspecified."
    exit 1
  fi
}

declare -r auxdir="$1"
declare -r file=$(basename "$2")

error-if-empty $auxdir auxdir
# Since this is a wrapper around latexmk to workaround the fact that latexmk
# seems to compile all .tex files it finds regardless of whether or not they've
# been updated, the filename argument is required.
error-if-empty $file File

declare -r ext=${file##*.}

if [[ $ext == 'tex' ]]; then
  declare -r pdf=${file%.*}.pdf
  declare -r auxpdf=$auxdir/$pdf

  latexmk -lualatex -outdir=$auxdir $file
  [[ -e $auxpdf ]] && ln -fs $auxpdf .
else
  latexmk -lualatex -outdir=$auxdir

  if ls $auxdir/*.pdf >/dev/null 2>&1; then
    ln -fs $auxdir/*.pdf .
  fi
fi
